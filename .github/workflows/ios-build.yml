name: Build and Deploy Web PWA

on:
  workflow_dispatch:
  push:
    branches: [main]

env:
  GODOT_VERSION: "4.3.0"
  PROJECT_PATH: "."
  EXPORT_NAME: "uniformcheck"

jobs:
  build-web:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          lfs: true

      - name: Setup Godot
        uses: chickensoft-games/setup-godot@v2
        with:
          version: ${{ env.GODOT_VERSION }}
          use-dotnet: false
          include-templates: true

      - name: Import project
        run: |
          godot --headless --import
          sleep 5

      - name: Export Web
        run: |
          mkdir -p build/web
          godot --headless --export-release "Web" build/web/index.html

      - name: Copy headers file for Netlify
        run: |
          cp _headers build/web/_headers || true
          cp netlify.toml build/web/ || true

      - name: Create PWA manifest
        run: |
          cat > build/web/manifest.json << 'EOF'
          {
            "name": "制服チェックゲーム",
            "short_name": "制服チェック",
            "description": "制服チェックミニゲーム",
            "start_url": "./index.html",
            "display": "standalone",
            "background_color": "#1e1e1e",
            "theme_color": "#ff88aa",
            "orientation": "portrait",
            "icons": [
              {
                "src": "index.icon.png",
                "sizes": "180x180",
                "type": "image/png"
              }
            ]
          }
          EOF

      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: web-build
          path: build/web
          retention-days: 30

      - name: Deploy to Netlify
        uses: nwtgck/actions-netlify@v3
        with:
          publish-dir: './build/web'
          production-deploy: true
        env:
          NETLIFY_AUTH_TOKEN: ${{ secrets.NETLIFY_AUTH_TOKEN }}
          NETLIFY_SITE_ID: ${{ secrets.NETLIFY_SITE_ID }}
        if: env.NETLIFY_AUTH_TOKEN != '' && env.NETLIFY_SITE_ID != ''
