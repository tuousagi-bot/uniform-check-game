name: Build and Deploy Web PWA

on:
  workflow_dispatch:
  push:
    branches: [main]

env:
  GODOT_VERSION: "4.3.0"
  PROJECT_PATH: "."
  EXPORT_NAME: "uniformcheck"

permissions:
  contents: read
  pages: write
  id-token: write

jobs:
  build-web:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          lfs: true

      - name: Setup Godot
        uses: chickensoft-games/setup-godot@v2
        with:
          version: ${{ env.GODOT_VERSION }}
          use-dotnet: false
          include-templates: true

      - name: Import project
        run: |
          godot --headless --import
          sleep 5

      - name: Export Web
        run: |
          mkdir -p build/web
          godot --headless --export-release "Web" build/web/index.html

      - name: Create PWA manifest
        run: |
          cat > build/web/manifest.json << 'EOF'
          {
            "name": "制服チェックゲーム",
            "short_name": "制服チェック",
            "description": "制服チェックミニゲーム",
            "start_url": "./index.html",
            "display": "standalone",
            "background_color": "#1e1e1e",
            "theme_color": "#ff88aa",
            "orientation": "portrait",
            "icons": [
              {
                "src": "index.icon.png",
                "sizes": "180x180",
                "type": "image/png"
              }
            ]
          }
          EOF

      - name: Setup Pages
        uses: actions/configure-pages@v4

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: build/web

  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: build-web
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
